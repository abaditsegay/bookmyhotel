<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontdesk Checkout Access</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .warning { color: #f39c12; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            background: #ecf0f1;
        }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Frontdesk Checkout Access</h1>
        <p>This page tests whether users with FRONTDESK role can access checkout functionality.</p>
        
        <div>
            <h3>üîë Login Test</h3>
            <input type="email" id="email" placeholder="Enter frontdesk email" value="frontdesk@example.com">
            <input type="password" id="password" placeholder="Enter password" value="password">
            <br>
            <button onclick="testLogin()">üîê Test Login</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div>
            <h3>üìä Test API Access</h3>
            <button onclick="testFrontDeskStats()">üìà Test Stats Access</button>
            <button onclick="testBookingsAccess()">üìã Test Bookings Access</button>
            <button onclick="testCheckoutAccess()">‚úÖ Test Checkout Access</button>
            <div id="apiResults" class="result" style="display: none;"></div>
        </div>

        <div>
            <h3>üéØ Test Frontend Auth Context</h3>
            <button onclick="testAuthContext()">üîç Test canAccessCheckout()</button>
            <div id="authContextResult" class="result" style="display: none;"></div>
        </div>

        <div>
            <h3>üìù Test Results Summary</h3>
            <div id="summaryResults" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testResults = [];

        function addResult(test, status, message) {
            testResults.push({test, status, message, timestamp: new Date().toISOString()});
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summaryResults');
            summary.style.display = 'block';
            summary.innerHTML = `
                <h4>Test Summary (${testResults.length} tests)</h4>
                ${testResults.map(r => `
                    <div class="${r.status}">
                        [${r.timestamp.substring(11, 19)}] ${r.test}: ${r.message}
                    </div>
                `).join('')}
            `;
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                result.style.display = 'block';
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    result.innerHTML = `
                        <div class="success">‚úÖ Login successful!</div>
                        <div class="info">Token: ${authToken ? authToken.substring(0, 50) + '...' : 'null'}</div>
                        <div class="info">User: ${data.user?.email || 'N/A'}</div>
                        <div class="info">Roles: ${JSON.stringify(data.user?.roles || data.user?.role || 'N/A')}</div>
                    `;
                    addResult('Login', 'success', `Successfully logged in as ${data.user?.email} with roles: ${JSON.stringify(data.user?.roles || data.user?.role)}`);
                } else {
                    const errorText = await response.text();
                    result.innerHTML = `<div class="error">‚ùå Login failed: ${response.status} - ${errorText}</div>`;
                    addResult('Login', 'error', `Login failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Login error: ${error.message}</div>`;
                addResult('Login', 'error', `Login error: ${error.message}`);
            }
        }

        async function testFrontDeskStats() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const result = document.getElementById('apiResults');
            result.style.display = 'block';
            
            try {
                const response = await fetch('http://localhost:8080/api/front-desk/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML += `<div class="success">‚úÖ Stats access successful: ${JSON.stringify(data)}</div>`;
                    addResult('Stats Access', 'success', 'Can access front desk stats');
                } else {
                    const errorText = await response.text();
                    result.innerHTML += `<div class="error">‚ùå Stats access failed: ${response.status} - ${errorText}</div>`;
                    addResult('Stats Access', 'error', `Stats access failed: ${response.status}`);
                }
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Stats error: ${error.message}</div>`;
                addResult('Stats Access', 'error', `Stats error: ${error.message}`);
            }
        }

        async function testBookingsAccess() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const result = document.getElementById('apiResults');
            result.style.display = 'block';
            
            try {
                const response = await fetch('http://localhost:8080/api/front-desk/bookings?page=0&size=5', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML += `<div class="success">‚úÖ Bookings access successful: Found ${data.content?.length || 0} bookings</div>`;
                    addResult('Bookings Access', 'success', `Can access bookings (${data.content?.length || 0} found)`);
                } else {
                    const errorText = await response.text();
                    result.innerHTML += `<div class="error">‚ùå Bookings access failed: ${response.status} - ${errorText}</div>`;
                    addResult('Bookings Access', 'error', `Bookings access failed: ${response.status}`);
                }
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Bookings error: ${error.message}</div>`;
                addResult('Bookings Access', 'error', `Bookings error: ${error.message}`);
            }
        }

        async function testCheckoutAccess() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const result = document.getElementById('apiResults');
            result.style.display = 'block';
            
            // Test checkout endpoint (we'll use a dummy ID since this is just for permission testing)
            try {
                const response = await fetch('http://localhost:8080/api/front-desk/checkout-with-receipt/999', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });

                // Even if the booking doesn't exist, a 404 means we have permission
                // A 403 means we don't have permission
                if (response.status === 404) {
                    result.innerHTML += `<div class="success">‚úÖ Checkout access granted (booking not found, but permission OK)</div>`;
                    addResult('Checkout Access', 'success', 'Has permission to access checkout endpoints');
                } else if (response.status === 403) {
                    result.innerHTML += `<div class="error">‚ùå Checkout access denied: 403 Forbidden</div>`;
                    addResult('Checkout Access', 'error', 'Permission denied for checkout endpoints');
                } else {
                    const errorText = await response.text();
                    result.innerHTML += `<div class="warning">‚ö†Ô∏è Checkout test returned: ${response.status} - ${errorText}</div>`;
                    addResult('Checkout Access', 'warning', `Unexpected response: ${response.status}`);
                }
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Checkout error: ${error.message}</div>`;
                addResult('Checkout Access', 'error', `Checkout error: ${error.message}`);
            }
        }

        async function testAuthContext() {
            const result = document.getElementById('authContextResult');
            result.style.display = 'block';
            
            // This simulates what the frontend AuthContext does
            try {
                // Create a mock user object based on login response
                const mockUser = {
                    email: document.getElementById('email').value,
                    roles: ['FRONTDESK'],  // or role: 'FRONTDESK' for backward compatibility
                };
                
                // Simulate the helper functions from AuthContext
                const hasRole = (role) => {
                    const userRoles = mockUser.roles && mockUser.roles.length > 0 ? mockUser.roles : (mockUser.role ? [mockUser.role] : []);
                    return userRoles.includes(role);
                };
                
                const hasAnyRole = (roles) => {
                    const userRoles = mockUser.roles && mockUser.roles.length > 0 ? mockUser.roles : (mockUser.role ? [mockUser.role] : []);
                    return roles.some(role => userRoles.includes(role));
                };
                
                const canAccessCheckout = () => {
                    return hasAnyRole(['FRONTDESK', 'HOTEL_ADMIN', 'ADMIN']);
                };
                
                const canEditBookings = () => {
                    return hasAnyRole(['FRONTDESK', 'HOTEL_ADMIN', 'ADMIN']);
                };
                
                // Test the functions
                const checkoutAccess = canAccessCheckout();
                const editAccess = canEditBookings();
                const frontdeskRole = hasRole('FRONTDESK');
                
                result.innerHTML = `
                    <div class="info">Mock User: ${JSON.stringify(mockUser)}</div>
                    <div class="info">hasRole('FRONTDESK'): ${frontdeskRole}</div>
                    <div class="info">canAccessCheckout(): ${checkoutAccess}</div>
                    <div class="info">canEditBookings(): ${editAccess}</div>
                    ${checkoutAccess ? 
                        '<div class="success">‚úÖ Frontend auth context allows checkout access</div>' : 
                        '<div class="error">‚ùå Frontend auth context denies checkout access</div>'}
                `;
                
                addResult('Frontend Auth Context', checkoutAccess ? 'success' : 'error', 
                    `canAccessCheckout() returns ${checkoutAccess}`);
                
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Auth context test error: ${error.message}</div>`;
                addResult('Frontend Auth Context', 'error', `Auth context error: ${error.message}`);
            }
        }

        // Initialize on page load
        window.onload = function() {
            addResult('Page Load', 'info', 'Test page initialized');
        };
    </script>
</body>
</html>
